# Introduction to SSD FTL （简单介绍 FTL 的功能，包括地址映射，垃圾回收，损耗均衡）

@（SSD学习笔记）

## FTL简介
 > 闪存转换层（flash translation layer, FTL）,完成主机（或者用户，Host）**逻辑地址空间**到闪存（Flash）**物理空间地址**的翻译（Translation），或者说映射（Mapping）。

SSD每把一笔用户逻辑数据写入闪存地址空间，便记录下该逻辑地址到物理地址的映射关系。当主机想读取该数据时，SSD便会根据这个映射，从闪存读取这笔数据后返回给用户。**FTL可以说是SSD固件的核心组成。**

## FTL的功能

### 映射管理

根据 **映射粒度** 的不同，FTL映射分为如下几种：
- **块映射** 
- **页映射**  
- **混合映射**  

三种映射的对比：

|  | 块映射 | 页映射 | 混合映射|
|-----|--------|------|-------|
|映射单元 | 物理块 | 物理页 | 块页结合|
|顺序写性能|好|好|好|
|顺序读性能|好|好|好|
|随机写性能|很差|好|差|
|随机读性能|好|好|好|
|映射表大小|小|大|一般|

>**注意：** 现在的SSD基本都是采用页映射方式。

#### 映射原理

SSD内部维护一张 **映射表** 。每次用户写入逻辑页时，就会产生一个新的映射关系，会加入或者更改映射表。当读取逻辑页时，SSD先查询映射表中的该逻辑页对应的物理页，然后再访问。

大部分SSD的映射表放在板载DRAM当中，少数SSD采用二级映射，一级映射表常驻SRAM，二级映射表大部分在闪存中。
还有一种是HMB（Host Memory Buffer）把映射表放在主机内存中。HMB性能在DRAM和闪存中间。

#### 映射表的刷新

一般在一下几种情况下出发映射表写入闪存：
- **新产生的映射关系累积到一定的阈值**
- **用户写入的数据量到达一定的阈值**
- **闪存写完闪存块的数量到达一定的阈值**
- **其他**

写入策略：
- **全部更新** 
- **部分更新更新**

### 垃圾回收

垃圾回收操作的基本过程是：选择一个包含无效页的闪存块作为回收块；将回
收块中的有效页迁移到新的空闲页中，同时，修改相应的地址映射表；待回收块中
所有的有效页都已完成迁移后，擦除回收块，将其加入到空闲块池，以备使用。垃
圾回收操作属于固态盘的后台操作，虽然能够回收无效的存储空间，但是会阻塞用
户的 I/O 请求，降低固态盘的性能（这是为什么固态盘在使用一段时间后可能出现性
能急剧下降的主要原因），并增加固态盘的写放大和闪存块的损耗。

对垃圾回收算法的研究主要集中在以下五个方面：
- **触发垃圾回收操作的时机**
    - **主动触发**：固态盘 I/O 空闲时触发垃圾回收操作，避免阻塞用户的 I/O 请求，但是会增加固态盘的写放大和闪存块的擦除操作
    - **被动触发**：当空闲块的数量低于某个阈值时触发垃圾回收操作，这是固态盘正常运行的必要保证，但是可能会严重阻塞用户的 I/O 请求
- **如何选择回收快**
- **冷热数据划分算法**
- **分多阶段执行垃圾回收操作**
- **如何基于固态盘的并行结构设计高效的垃圾回收算法**

### 损耗均衡算法 
 > 由于擦写操作会对闪存造成永久性耗损，当一个块的擦写次数到达极限时，会成为坏块。这会导致闪存块之间的周期数不均衡。因此，
损耗均衡的目的在于均衡各个闪存块的损耗，避免部分闪存块过早地坏掉，从而延长固态盘的寿命。

根据触发时机的不同：
- **动态损耗均衡算法**：当需要分配空闲块以满足数据写入时，选择使用损耗最小的空闲块
- **静态损耗均衡算法**：把冷数据移动至耗损严重的块中

对损耗均衡的算法主要集中在两个方面：
- **如何更准确地实现损耗均衡**
- **如何减少损耗均衡操作的开销**